<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Professional Credit Card Calculator</title>
    <!-- 
        Content-Security-Policy: For production deployment, configure this via your web server (e.g., Nginx, Apache) 
        for best practice. If using a meta tag, ensure all CDN domains (Chart.js, jsPDF, SheetJS) are whitelisted.
        For this single-file, self-contained solution, inline scripts/styles require 'unsafe-inline'.
        Example for meta (adjust for your specific ad networks if they inject more):
        <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' cdnjs.cloudflare.com cdn.jsdelivr.net cdn.sheetjs.com; style-src 'self' 'unsafe-inline'; img-src * data:; media-src *; connect-src *;">
    -->
    
    <!-- External Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>

    <style>
        /* CSS Variables for theming */
        :root {
            --primary: #3498db;
            --secondary: #2ecc71;
            --danger: #e74c3c;
            --dark-heading-bg: #2c3e50; /* Used for table headers in light mode */
            --light-bg-secondary: #ecf0f1; /* Used for ad containers, tab non-active */
            --text-color: #333;
            --bg-color: #f9f9f9;
            --card-bg: #fff;
            --border-color: #ddd;
            --chart-color-principal: #3498db; /* Blue */
            --chart-color-interest: #e74c3c; /* Red */
            --chart-color-balance: #9b59b6; /* Purple */
        }
        
        /* Dark Theme Variables */
        [data-theme="dark"] {
            --primary: #2980b9;
            --secondary: #27ae60;
            --danger: #c0392b;
            --dark-heading-bg: #34495e; /* Adjusted for dark mode table headers */
            --light-bg-secondary: #4a667e; /* Adjusted for dark mode ad containers/tabs */
            --text-color: #ecf0f1;
            --bg-color: #2c3e50;
            --card-bg: #34495e;
            --border-color: #555;
            --chart-color-principal: #4a90e2; 
            --chart-color-interest: #ff6b6b;
            --chart-color-balance: #c792ea;
        }
        
        /* Global Styles */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: var(--text-color);
            background-color: var(--bg-color);
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            transition: all 0.3s ease; /* Smooth transition for theme change */
        }
        
        .calculator-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }
        
        @media (min-width: 768px) {
            .calculator-container {
                grid-template-columns: 1fr 1fr;
            }
        }
        
        .input-section, .results-section {
            background: var(--card-bg);
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        h1, h2, h3 {
            color: var(--primary);
        }
        
        .input-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }
        
        input, select {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 16px;
            background-color: var(--card-bg);
            color: var(--text-color);
            transition: border-color 0.3s, background-color 0.3s, color 0.3s;
        }
        
        /* Buttons */
        button {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        
        button:hover {
            background-color: var(--secondary);
        }

        .btn-secondary {
            background-color: #6c757d;
        }

        .btn-secondary:hover {
            background-color: #5a6268;
        }
        
        /* Ad Containers */
        .ad-container {
            margin: 20px 0;
            padding: 15px;
            background: var(--light-bg-secondary);
            border-radius: 4px;
            text-align: center;
            min-height: 90px;
            color: var(--text-color);
            display: flex; /* For centering text */
            align-items: center;
            justify-content: center;
            flex-direction: column;
            border: 1px dashed var(--border-color);
        }
        
        .chart-container {
            height: 300px;
            margin: 20px 0;
        }
        
        /* Summary Cards */
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .summary-card {
            background: var(--card-bg);
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            text-align: center;
            transition: background-color 0.3s, box-shadow 0.3s;
        }
        
        .summary-card h3 {
            margin-top: 0;
            font-size: 16px;
            color: var(--text-color); /* Use theme variable */
        }
        
        .summary-card p {
            font-size: 24px;
            font-weight: bold;
            margin: 10px 0;
            color: var(--primary); /* Use primary color */
        }
        
        /* Tables */
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            color: var(--text-color);
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }
        
        th {
            background-color: var(--dark-heading-bg); /* Use dark card bg for table headers */
            color: white;
        }
        
        tr:hover {
            background-color: rgba(0,0,0,0.05); /* Light mode hover */
        }
        [data-theme="dark"] tr:hover {
            background-color: rgba(255,255,255,0.05); /* Dark mode hover */
        }
        
        /* Tooltips */
        .tooltip {
            position: relative;
            display: inline-block;
            cursor: help;
            color: var(--primary);
            font-size: 0.9em;
            margin-left: 5px;
        }
        
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 250px; /* Wider for more text */
            background-color: var(--dark-heading-bg);
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 10px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 14px;
            font-weight: normal;
        }
        
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
        
        /* Export & Share Options */
        .export-options, .social-sharing {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin: 20px 0;
        }
        
        .social-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 8px 12px;
            border-radius: 4px;
            color: white;
            text-decoration: none;
            font-size: 14px;
            transition: opacity 0.3s;
        }
        .social-btn:hover {
            opacity: 0.8;
        }
        
        .email { background-color: #777; }
        .whatsapp { background-color: #25D366; }
        .linkedin { background-color: #0077B5; }
        .twitter { background-color: #1DA1F2; }
        
        /* Tabs */
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--border-color);
        }
        
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            background-color: var(--light-bg-secondary);
            border: none;
            border-radius: 4px 4px 0 0;
            margin-right: 5px;
            color: var(--text-color);
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .tab.active {
            background-color: var(--primary);
            color: white;
            border-bottom: 2px solid var(--primary);
        }
        .tab:not(.active):hover {
            background-color: rgba(var(--primary), 0.1); /* Subtle hover for non-active */
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Theme Toggle Button */
        .theme-toggle {
            position: absolute; 
            top: 20px;
            right: 20px;
            background: var(--primary);
            color: white;
            border: none;
            padding: 10px;
            border-radius: 50%;
            cursor: pointer;
            z-index: 1000;
            font-size: 1.2em;
            width: 40px; /* Fixed width/height for round button */
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: background-color 0.3s, box-shadow 0.3s;
        }
        
        /* Error Messages */
        .error-message {
            color: var(--danger);
            font-size: 0.9em;
            margin-top: 5px;
        }

        /* How to Use / Disclaimer Section */
        .info-section {
            background: var(--card-bg);
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-top: 20px;
        }
        .info-section h2 {
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: var(--text-color); /* Ensure heading matches text color */
        }
        .info-content {
            display: none;
            color: var(--text-color); /* Ensure content matches text color */
        }
        .info-content.active {
            display: block;
        }
        .info-section p {
            margin-bottom: 10px;
        }
        .info-section ul {
            list-style-type: disc;
            margin-left: 20px;
            margin-bottom: 10px;
        }
        .info-section li {
            margin-bottom: 5px;
        }

        /* Print Specific Styles */
        @media print {
            .no-print, .ad-container, .theme-toggle, .info-section, .export-options, .social-sharing, .tabs {
                display: none !important;
            }
            body {
                background: none;
                padding: 0;
                color: black; /* Force black text for print */
            }
            .calculator-container {
                display: block;
            }
            .input-section {
                display: none; /* Hide input section in print */
            }
            .results-section {
                box-shadow: none; /* Remove shadow for print */
                padding: 0;
            }
            table {
                font-size: 10px; /* Smaller font for print tables */
                color: black;
            }
            th, td {
                padding: 8px;
                border-color: #ccc; /* Lighter border for print */
            }
            th {
                background-color: #eee !important; /* Lighter header for print */
                color: black !important;
            }
            tr:hover {
                background-color: transparent !important;
            }
            .chart-container canvas {
                max-width: 500px; /* Constrain chart size for print */
                max-height: 300px;
                display: block; /* Ensure chart is block level for print */
                margin: 0 auto;
            }
            .summary-card h3, .summary-card p {
                color: black !important; /* Ensure readable colors in print */
            }
        }
    </style>
</head>
<body>
    <button class="theme-toggle no-print" id="themeToggle" aria-label="Toggle dark/light mode">üåì</button>
    
    <h1>Professional Credit Card Calculator</h1>
    
    <div class="calculator-container">
        <div class="input-section">
            <h2>Debt Details</h2>
            
            <div class="input-group">
                <label for="currentBalance">
                    Current Balance ($)
                    <span class="tooltip">‚ÑπÔ∏è
                        <span class="tooltiptext">
                            The current outstanding balance on your credit card.
                        </span>
                    </span>
                </label>
                <input type="number" id="currentBalance" min="0" step="10" value="5000" aria-describedby="currentBalance-error">
                <div class="error-message" id="currentBalance-error" role="alert" aria-live="polite"></div>
            </div>
            
            <div class="input-group">
                <label for="apr">
                    Annual Percentage Rate (APR) (%)
                    <span class="tooltip">‚ÑπÔ∏è
                        <span class="tooltiptext">
                            The annual interest rate on your credit card debt.
                        </span>
                    </span>
                </label>
                <input type="number" id="apr" min="0" max="36" step="0.01" value="19.99" aria-describedby="apr-error">
                <div class="error-message" id="apr-error" role="alert" aria-live="polite"></div>
            </div>
            
            <div class="input-group">
                <label for="monthlyPayment">
                    Monthly Payment ($)
                    <span class="tooltip">‚ÑπÔ∏è
                        <span class="tooltiptext">
                            Your desired monthly payment, including any additional payments. 
                            Leave blank or set to 0 to calculate using minimum payment.
                        </span>
                    </span>
                </label>
                <input type="number" id="monthlyPayment" min="0" step="10" placeholder="e.g., 100 (Optional)" aria-describedby="monthlyPayment-error">
                <div class="error-message" id="monthlyPayment-error" role="alert" aria-live="polite"></div>
            </div>

            <div class="input-group">
                <label for="minPaymentRate">
                    Minimum Payment Rate (%)
                    <span class="tooltip">‚ÑπÔ∏è
                        <span class="tooltiptext">
                            The typical percentage of your balance used to calculate the minimum payment (e.g., 2% to 4%).
                        </span>
                    </span>
                </label>
                <input type="number" id="minPaymentRate" min="0" max="10" step="0.1" value="2.0" aria-describedby="minPaymentRate-error">
                <div class="error-message" id="minPaymentRate-error" role="alert" aria-live="polite"></div>
            </div>

            <div class="input-group">
                <label for="minPaymentFloor">
                    Minimum Payment Floor ($)
                    <span class="tooltip">‚ÑπÔ∏è
                        <span class="tooltiptext">
                            The fixed minimum amount charged if the percentage-based minimum payment is lower (e.g., $25).
                        </span>
                    </span>
                </label>
                <input type="number" id="minPaymentFloor" min="0" step="1" value="25" aria-describedby="minPaymentFloor-error">
                <div class="error-message" id="minPaymentFloor-error" role="alert" aria-live="polite"></div>
            </div>
            
            <button id="calculateBtn">Calculate Payoff</button>
            <button id="addComparisonBtn" class="btn-secondary no-print">Add to Comparison</button>
        </div>
        
        <div class="results-section">
            <h2>Repayment Summary</h2>
            
            <div class="summary-cards">
                <div class="summary-card">
                    <h3>Estimated Payoff Time</h3>
                    <p id="payoffTime">0 Years, 0 Months</p>
                </div>
                <div class="summary-card">
                    <h3>Total Interest Paid</h3>
                    <p id="totalInterestPaid">$0.00</p>
                </div>
                <div class="summary-card">
                    <h3>Total Repayment Amount</h3>
                    <p id="totalRepaymentAmount">$0.00</p>
                </div>
                <div class="summary-card">
                    <h3>Actual Monthly Payment</h3>
                    <p id="actualMonthlyPayment">$0.00</p>
                </div>
            </div>
            
            <div class="chart-container">
                <canvas id="repaymentChart" aria-label="Debt Repayment Breakdown Chart"></canvas>
            </div>
            
            <div class="tabs">
                <button class="tab active" data-tab="amortization-schedule" aria-controls="amortization-schedule-tab">Amortization Schedule</button>
                <button class="tab" data-tab="comparison" aria-controls="comparison-tab">Comparison</button>
            </div>
            
            <div class="tab-content active" id="amortization-schedule-tab" role="tabpanel" aria-labelledby="amortization-schedule-tab-btn">
                <h3>Detailed Amortization Schedule</h3>
                <div style="overflow-x: auto;">
                    <table id="amortizationTable">
                        <thead>
                            <tr>
                                <th>Month</th>
                                <th>Starting Balance</th>
                                <th>Payment</th>
                                <th>Interest Paid</th>
                                <th>Principal Paid</th>
                                <th>Ending Balance</th>
                                <th>Cum. Interest</th>
                                <th>Cum. Principal</th>
                            </tr>
                        </thead>
                        <tbody id="amortizationTableBody">
                            <!-- Will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="tab-content" id="comparison-tab" role="tabpanel" aria-labelledby="comparison-tab-btn">
                <h3>Compared Scenarios</h3>
                <div style="overflow-x: auto;">
                    <table id="comparisonTable">
                        <thead>
                            <tr>
                                <th>Scenario</th>
                                <th>Balance</th>
                                <th>APR</th>
                                <th>Monthly Pmt</th>
                                <th>Payoff Time</th>
                                <th>Total Interest</th>
                                <th>Total Repayment</th>
                                <th class="no-print">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="comparisonBody">
                            <!-- Will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
                <button id="clearComparisonBtn" class="btn-secondary no-print">Clear All Comparisons</button>
            </div>
            
            <div class="ad-container">
                <!-- Adsterra Responsive Banner Ad Code Here -->
                Advertisement Space (Adsterra Responsive Banner)
                <small>This space is reserved for ad network code (e.g., 728x90).</small>
            </div>

            <div class="export-options no-print">
                <button id="printBtn">Print Summary</button>
                <button id="pdfBtn">Save as PDF</button>
                <button id="excelBtn">Save as Excel</button>
                <button id="csvBtn">Save as CSV</button>
                <button id="txtBtn">Save as TXT</button>
            </div>
            
            <div class="social-sharing no-print">
                <button class="social-btn email" id="emailShare" aria-label="Share via Email">Email</button>
                <button class="social-btn whatsapp" id="whatsappShare" aria-label="Share via WhatsApp">WhatsApp</button>
                <button class="social-btn linkedin" id="linkedinShare" aria-label="Share via LinkedIn">LinkedIn</button>
                <button class="social-btn twitter" id="twitterShare" aria-label="Share via Twitter">Twitter</button>
                <button class="social-btn btn-secondary" id="shareLink" aria-label="Copy Shareable Link">Copy Share Link</button>
            </div>

            <div class="ad-container" style="height: 250px;">
                <!-- Yllix Sidebar/Floating Ad Code Here -->
                Advertisement Space (Yllix Sidebar/Floating)
                <small>This space is reserved for ad network code (e.g., 300x250).</small>
            </div>
        </div>
    </div>

    <div class="info-section">
        <h2 id="howToUseToggle" aria-expanded="false" aria-controls="howToUseContent">
            How to Use This Calculator <span aria-hidden="true">‚ñº</span>
        </h2>
        <div class="info-content" id="howToUseContent">
            <p>This calculator helps you estimate how long it will take to pay off your credit card debt and how much interest you'll pay.</p>
            <ul>
                <li><strong>Current Balance:</strong> Your current outstanding debt on the credit card.</li>
                <li><strong>Annual Percentage Rate (APR):</strong> The yearly interest rate charged by your credit card issuer.</li>
                <li><strong>Monthly Payment:</strong>
                    <ul>
                        <li>Leave this field blank or enter 0 to calculate using your card's minimum payment.</li>
                        <li>Enter a specific amount if you plan to pay more than the minimum.</li>
                    </ul>
                </li>
                <li><strong>Minimum Payment Rate (%):</strong> The percentage of your balance that your credit card issuer uses to calculate your minimum payment (e.g., 2%, 3%, or 4%).</li>
                <li><strong>Minimum Payment Floor ($):</strong> The fixed minimum amount (e.g., $25) charged if the percentage-based minimum payment is lower.</li>
            </ul>
            <p><strong>What the Results Mean:</strong></p>
            <ul>
                <li><strong>Estimated Payoff Time:</strong> How many years and months it will take to pay off your debt.</li>
                <li><strong>Total Interest Paid:</strong> The total amount of interest you will pay over the entire repayment period.</li>
                <li><strong>Total Repayment Amount:</strong> Your original balance plus the total interest paid.</li>
                <li><strong>Actual Monthly Payment:</strong> The determined monthly payment used in the calculation (either your custom amount or the calculated minimum payment).</li>
                <li><strong>Amortization Schedule:</strong> A detailed month-by-month breakdown of your payments, showing how much goes to interest and how much reduces your principal balance.</li>
                <li><strong>Comparison Tool:</strong> Allows you to save multiple repayment scenarios (e.g., minimum payment vs. an accelerated payment) and compare them side-by-side to see interest savings.</li>
            </ul>
            <p style="font-style: italic; color: var(--danger);"><strong>Disclaimer:</strong> This calculator provides estimates based on your inputs and simplified credit card repayment models. It does not account for new purchases, annual fees, late payment fees, specific credit card issuer policies, or changes in interest rates. It is for informational purposes only and should not be considered financial advice. Actual results may vary. Consult your credit card issuer or a financial advisor for personalized guidance.</p>
        </div>
    </div>

    <script>
        // Global variables to store calculation results and chart instance
        let currentRepaymentResults = {};
        let amortizationSchedule = [];
        let repaymentChartInstance = null; // To manage Chart.js instance
        let comparedScenarios = []; // Array to store comparison scenarios

        // Constants for calculation and display limits
        const MAX_REPAYMENT_PERIODS = 600; // Limit to 50 years of monthly payments to prevent infinite loops
        const MIN_PAYMENT_RATE_DEFAULT = 2.0; // Default min payment rate %
        const MIN_PAYMENT_FLOOR_DEFAULT = 25.0; // Default min payment floor $

        document.addEventListener('DOMContentLoaded', function() {
            // Set up theme toggle
            const savedTheme = localStorage.getItem('theme') || 'light'; 
            document.documentElement.setAttribute('data-theme', savedTheme);
            document.getElementById('themeToggle').addEventListener('click', toggleTheme);
            
            // Set up tab functionality for comparison
            setupTabs();
            
            // Set up event listeners for calculation and exports
            document.getElementById('calculateBtn').addEventListener('click', calculatePayoff);
            document.getElementById('addComparisonBtn').addEventListener('click', addScenarioToComparison);
            document.getElementById('clearComparisonBtn').addEventListener('click', clearAllComparisons);
            document.getElementById('printBtn').addEventListener('click', printSummary);
            document.getElementById('pdfBtn').addEventListener('click', exportToPDF);
            document.getElementById('excelBtn').addEventListener('click', exportToExcel);
            document.getElementById('csvBtn').addEventListener('click', exportToCSV);
            document.getElementById('txtBtn').addEventListener('click', exportToTXT);
            document.getElementById('shareLink').addEventListener('click', copyShareLink);

            // Set up how-to-use toggle
            const howToUseToggle = document.getElementById('howToUseToggle');
            const howToUseContent = document.getElementById('howToUseContent');
            howToUseToggle.addEventListener('click', function() {
                const isExpanded = this.getAttribute('aria-expanded') === 'true';
                this.setAttribute('aria-expanded', !isExpanded);
                howToUseContent.classList.toggle('active');
                howToUseToggle.querySelector('span').textContent = isExpanded ? '‚ñº' : '‚ñ≤';
            });
            // Initial state for how-to-use
            howToUseContent.classList.remove('active');
            howToUseToggle.setAttribute('aria-expanded', 'false');
            howToUseToggle.querySelector('span').textContent = '‚ñº';

            // Decode share link parameters on page load if present
            decodeShareLink();
            
            // Initial calculation to populate the UI (from default values or decoded link)
            calculatePayoff();
            setupSocialSharing(); // Needs initial data
        });
        
        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            if (currentTheme === 'dark') {
                document.documentElement.setAttribute('data-theme', 'light');
                localStorage.setItem('theme', 'light');
            } else {
                document.documentElement.setAttribute('data-theme', 'dark');
                localStorage.setItem('theme', 'dark');
            }
            // Update chart colors on theme change
            if (repaymentChartInstance) {
                const rootStyle = getComputedStyle(document.documentElement);
                repaymentChartInstance.data.datasets[0].borderColor = rootStyle.getPropertyValue('--chart-color-balance');
                repaymentChartInstance.data.datasets[0].backgroundColor = rootStyle.getPropertyValue('--chart-color-balance');
                repaymentChartInstance.data.datasets[1].borderColor = rootStyle.getPropertyValue('--chart-color-interest');
                repaymentChartInstance.data.datasets[1].backgroundColor = rootStyle.getPropertyValue('--chart-color-interest');
                repaymentChartInstance.options.plugins.legend.labels.color = rootStyle.getPropertyValue('--text-color');
                repaymentChartInstance.options.plugins.title.color = rootStyle.getPropertyValue('--text-color');
                repaymentChartInstance.options.scales.x.ticks.color = rootStyle.getPropertyValue('--text-color');
                repaymentChartInstance.options.scales.y.ticks.color = rootStyle.getPropertyValue('--text-color');
                repaymentChartInstance.update();
            }
        }
        
        function setupTabs() {
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    this.classList.add('active');
                    const tabId = this.getAttribute('data-tab');
                    document.getElementById(`${tabId}-tab`).classList.add('active');
                });
            });
        }

        // --- Error Handling Utilities ---
        function clearErrors() {
            document.querySelectorAll('.error-message').forEach(el => el.textContent = '');
        }

        function showError(elementId, message) {
            document.getElementById(elementId).textContent = message;
        }
        
        // --- Core Debt Repayment Logic ---
        function calculatePayoff() {
            clearErrors(); // Clear previous errors

            // Get input values
            const currentBalance = parseFloat(document.getElementById('currentBalance').value);
            let annualAPR = parseFloat(document.getElementById('apr').value);
            let desiredMonthlyPayment = parseFloat(document.getElementById('monthlyPayment').value);
            let minPaymentRate = parseFloat(document.getElementById('minPaymentRate').value);
            let minPaymentFloor = parseFloat(document.getElementById('minPaymentFloor').value);

            // Convert percentages to decimals
            annualAPR /= 100;
            minPaymentRate /= 100;
            
            // --- Input Validation ---
            let isValid = true;
            if (isNaN(currentBalance) || currentBalance < 0) {
                showError('currentBalance-error', 'Must be a non-negative number.'); isValid = false;
            }
            if (isNaN(annualAPR) || annualAPR < 0 || annualAPR > 0.36) { // Max 36% for credit cards
                showError('apr-error', 'APR must be between 0% and 36%.'); isValid = false;
            }
            // Note: desiredMonthlyPayment can be NaN if optional field is empty, handled below
            if (isNaN(minPaymentRate) || minPaymentRate < 0 || minPaymentRate > 0.10) { // 0-10% min payment rate
                showError('minPaymentRate-error', 'Must be between 0% and 10%.'); isValid = false;
            }
            if (isNaN(minPaymentFloor) || minPaymentFloor < 0) {
                showError('minPaymentFloor-error', 'Must be a non-negative number.'); isValid = false;
            }
            
            if (!isValid) {
                document.getElementById('results-section').style.display = 'none';
                return;
            }

            const monthlyAPR = annualAPR / 12;

            let actualMonthlyPayment;
            if (isNaN(desiredMonthlyPayment) || desiredMonthlyPayment <= 0) {
                // Calculate minimum payment if desiredMonthlyPayment is not provided or invalid
                const minPaymentByRate = currentBalance * minPaymentRate;
                actualMonthlyPayment = Math.max(minPaymentByRate, minPaymentFloor);
                // If balance is very low, min payment is just the balance
                if (currentBalance < actualMonthlyPayment) {
                     actualMonthlyPayment = currentBalance + (currentBalance * monthlyAPR); // Payoff is balance + one month interest
                }
            } else {
                actualMonthlyPayment = desiredMonthlyPayment;
            }

            // Early exit conditions for very low balance or 0 payment
            if (currentBalance <= 0) {
                currentRepaymentResults = {
                    currentBalance: 0,
                    apr: annualAPR * 100,
                    monthlyPayment: actualMonthlyPayment,
                    payoffTimeMonths: 0,
                    totalInterestPaid: 0,
                    totalRepaymentAmount: 0,
                    actualMonthlyPayment: 0
                };
                amortizationSchedule = [];
                updateSummaryCards(currentRepaymentResults);
                updateChart(currentRepaymentResults);
                displayAmortizationTable(amortizationSchedule);
                setupSocialSharing();
                document.getElementById('results-section').style.display = 'block';
                return;
            }
            
            // Validate minimum payment is enough to cover interest
            const firstMonthInterest = currentBalance * monthlyAPR;
            if (actualMonthlyPayment <= firstMonthInterest && currentBalance > 0 && annualAPR > 0) {
                showError('monthlyPayment-error', 'Payment too low to cover interest. Debt will never be paid off.');
                document.getElementById('results-section').style.display = 'none';
                return;
            }
            if (actualMonthlyPayment < 0.01 && currentBalance > 0) { // Payment is effectively zero but balance exists
                showError('monthlyPayment-error', 'Monthly payment must be positive to pay off debt.');
                document.getElementById('results-section').style.display = 'none';
                return;
            }

            // --- Amortization Calculation ---
            amortizationSchedule = [];
            let remainingBalance = currentBalance;
            let totalInterestPaid = 0;
            let totalPrincipalPaid = 0;
            let paymentsMade = 0;

            for (let i = 1; i <= MAX_REPAYMENT_PERIODS; i++) {
                if (remainingBalance <= 0.01) { // Balance paid off (allow small floating point error)
                    remainingBalance = 0; // Ensure exactly zero
                    break;
                }

                const interestThisMonth = remainingBalance * monthlyAPR;
                let principalThisMonth = actualMonthlyPayment - interestThisMonth;

                // Adjust for final payment
                if (remainingBalance < actualMonthlyPayment + interestThisMonth) { // If remaining balance is less than (payment + this month's interest)
                    principalThisMonth = remainingBalance; // Pay off exactly what's left
                    actualMonthlyPayment = remainingBalance + interestThisMonth; // Adjust actual payment for the last month
                }
                
                principalThisMonth = Math.max(0, principalThisMonth); // Principal cannot be negative
                totalInterestPaid += interestThisMonth;
                totalPrincipalPaid += principalThisMonth;
                remainingBalance -= principalThisMonth;
                paymentsMade = i;

                amortizationSchedule.push({
                    month: i,
                    startingBalance: parseFloat((currentBalance - (totalPrincipalPaid - principalThisMonth)).toFixed(2)),
                    payment: parseFloat(actualMonthlyPayment.toFixed(2)),
                    interestPaid: parseFloat(interestThisMonth.toFixed(2)),
                    principalPaid: parseFloat(principalThisMonth.toFixed(2)),
                    endingBalance: parseFloat(Math.max(0, remainingBalance).toFixed(2)),
                    cumulativeInterest: parseFloat(totalInterestPaid.toFixed(2)),
                    cumulativePrincipal: parseFloat(totalPrincipalPaid.toFixed(2))
                });
            }

            if (paymentsMade >= MAX_REPAYMENT_PERIODS) {
                showError('monthlyPayment-error', `Payment too low. Debt may not be paid off within ${MAX_REPAYMENT_PERIODS} months.`);
                // Set results to indicate long payoff
                totalInterestPaid = Infinity;
                paymentsMade = Infinity;
            }

            const payoffTimeYears = Math.floor(paymentsMade / 12);
            const payoffTimeMonths = paymentsMade % 12;
            const totalRepaymentAmount = currentBalance + totalInterestPaid;

            // Store results in global object
            currentRepaymentResults = {
                currentBalance: currentBalance,
                apr: annualAPR * 100, // For display
                monthlyPayment: parseFloat(document.getElementById('monthlyPayment').value), // Store input monthly payment for comparison
                minPaymentRate: minPaymentRate * 100,
                minPaymentFloor: minPaymentFloor,

                payoffTimeMonths: paymentsMade,
                payoffTimeFormatted: `${payoffTimeYears} Years, ${payoffTimeMonths} Months`,
                totalInterestPaid: totalInterestPaid,
                totalRepaymentAmount: totalRepaymentAmount,
                actualMonthlyPayment: actualMonthlyPayment // The calculated/used payment
            };

            // Update UI
            updateSummaryCards(currentRepaymentResults);
            updateChart(currentRepaymentResults, amortizationSchedule);
            displayAmortizationTable(amortizationSchedule);
            displayComparisonTable(); // Redraw comparison table in case it's open
            setupSocialSharing(); // Update sharing links with new data

            document.getElementById('results-section').style.display = 'block';
        }

        // --- Comparison Logic ---
        function addScenarioToComparison() {
            if (Object.keys(currentRepaymentResults).length === 0 || isNaN(currentRepaymentResults.payoffTimeMonths)) {
                alert("Please calculate a valid repayment scenario first before adding to comparison.");
                return;
            }
            
            const scenarioName = prompt("Enter a name for this scenario (e.g., 'Minimum Payment', 'Extra $50/month'):");
            if (!scenarioName) return; // User cancelled or entered empty name

            const newScenario = {
                id: Date.now(), // Unique ID
                name: scenarioName,
                currentBalance: currentRepaymentResults.currentBalance,
                apr: currentRepaymentResults.apr,
                monthlyPayment: currentRepaymentResults.monthlyPayment, // The value the user input
                actualMonthlyPayment: currentRepaymentResults.actualMonthlyPayment, // The value actually used
                payoffTimeFormatted: currentRepaymentResults.payoffTimeFormatted,
                totalInterestPaid: currentRepaymentResults.totalInterestPaid,
                totalRepaymentAmount: currentRepaymentResults.totalRepaymentAmount
            };
            comparedScenarios.push(newScenario);
            displayComparisonTable();
            // Switch to comparison tab if it's not active
            document.querySelector('.tabs .tab[data-tab="comparison"]').click();
        }

        function removeScenarioFromComparison(idToRemove) {
            comparedScenarios = comparedScenarios.filter(scenario => scenario.id !== idToRemove);
            displayComparisonTable();
        }

        function clearAllComparisons() {
            if (confirm("Are you sure you want to clear all compared scenarios? This action cannot be undone.")) {
                comparedScenarios = [];
                displayComparisonTable();
            }
        }

        // --- UI Update Functions ---
        function updateSummaryCards(results) {
            document.getElementById('payoffTime').textContent = results.payoffTimeFormatted;
            document.getElementById('totalInterestPaid').textContent = formatCurrency(results.totalInterestPaid);
            document.getElementById('totalRepaymentAmount').textContent = formatCurrency(results.totalRepaymentAmount);
            document.getElementById('actualMonthlyPayment').textContent = formatCurrency(results.actualMonthlyPayment);
        }
        
        function updateChart(results, schedule) {
            const ctx = document.getElementById('repaymentChart').getContext('2d');
            
            // Destroy previous chart if exists
            if (repaymentChartInstance) {
                repaymentChartInstance.destroy();
            }

            if (schedule.length === 0 || results.currentBalance <= 0) { // No meaningful data to chart
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                return;
            }

            // Create labels for every Nth month (e.g., every 6 or 12 months for long schedules)
            const interval = Math.ceil(schedule.length / 12); // At least every 12 months, max 50 points
            const labels = schedule.filter((_, i) => i % interval === 0 || i === schedule.length - 1).map(s => `Month ${s.month}`);
            
            const remainingBalanceData = schedule.filter((_, i) => i % interval === 0 || i === schedule.length - 1).map(s => s.endingBalance);
            const cumulativeInterestData = schedule.filter((_, i) => i % interval === 0 || i === schedule.length - 1).map(s => s.cumulativeInterest);
            const cumulativePrincipalData = schedule.filter((_, i) => i % interval === 0 || i === schedule.length - 1).map(s => s.cumulativePrincipal);


            const rootStyle = getComputedStyle(document.documentElement);
            const textColor = rootStyle.getPropertyValue('--text-color');
            const balanceColor = rootStyle.getPropertyValue('--chart-color-balance');
            const interestColor = rootStyle.getPropertyValue('--chart-color-interest');
            const principalColor = rootStyle.getPropertyValue('--chart-color-principal');

            repaymentChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Remaining Balance',
                            data: remainingBalanceData,
                            borderColor: balanceColor,
                            backgroundColor: balanceColor,
                            fill: false,
                            tension: 0.1,
                            pointRadius: 2,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Cumulative Interest Paid',
                            data: cumulativeInterestData,
                            borderColor: interestColor,
                            backgroundColor: interestColor,
                            fill: false,
                            tension: 0.1,
                            pointRadius: 2,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Cumulative Principal Paid',
                            data: cumulativePrincipalData,
                            borderColor: principalColor,
                            backgroundColor: principalColor,
                            fill: false,
                            tension: 0.1,
                            pointRadius: 2,
                            yAxisID: 'y'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                color: textColor
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${formatCurrency(context.raw)}`;
                                }
                            }
                        },
                        title: {
                            display: true,
                            text: 'Repayment Progress Over Time',
                            color: textColor
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Month',
                                color: textColor
                            },
                            ticks: {
                                color: textColor
                            },
                            grid: {
                                color: 'rgba(100,100,100,0.1)'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Amount ($)',
                                color: textColor
                            },
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                },
                                color: textColor
                            },
                            grid: {
                                color: 'rgba(100,100,100,0.1)'
                            }
                        }
                    }
                }
            });
        }

        function displayAmortizationTable(schedule) {
            const tableBody = document.getElementById('amortizationTableBody');
            tableBody.innerHTML = '';
            
            // Only show every 12th payment if there are many, plus first and last
            const showAllThreshold = 12 * 5; // Show all if 5 years or less (60 months)
            const showCondensed = schedule.length > showAllThreshold;
            
            schedule.forEach((period, i) => {
                const isEndOfYear = (i + 1) % 12 === 0;
                const isFirstOrLast = i === 0 || i === schedule.length - 1;

                if (!showCondensed || isEndOfYear || isFirstOrLast) {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${period.month}</td>
                        <td>${formatCurrency(period.startingBalance)}</td>
                        <td>${formatCurrency(period.payment)}</td>
                        <td>${formatCurrency(period.interestPaid)}</td>
                        <td>${formatCurrency(period.principalPaid)}</td>
                        <td>${formatCurrency(period.endingBalance)}</td>
                        <td>${formatCurrency(period.cumulativeInterest)}</td>
                        <td>${formatCurrency(period.cumulativePrincipal)}</td>
                    `;
                    tableBody.appendChild(row);
                } else if (i === Math.floor(schedule.length / 2) && showCondensed) {
                    // Add ellipsis row once in the middle for condensed view
                    const row = document.createElement('tr');
                    row.innerHTML = `<td colspan="8" style="text-align: center;">... (Table Condensed) ...</td>`;
                    tableBody.appendChild(row);
                }
            });
        }

        function displayComparisonTable() {
            const tableBody = document.getElementById('comparisonBody');
            tableBody.innerHTML = '';

            if (comparedScenarios.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="8" style="text-align: center;">No scenarios added for comparison yet.</td></tr>';
                return;
            }

            comparedScenarios.forEach(scenario => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${scenario.name}</td>
                    <td>${formatCurrency(scenario.currentBalance)}</td>
                    <td>${scenario.apr.toFixed(2)}%</td>
                    <td>${formatCurrency(scenario.actualMonthlyPayment)}</td>
                    <td>${scenario.payoffTimeFormatted}</td>
                    <td>${formatCurrency(scenario.totalInterestPaid)}</td>
                    <td>${formatCurrency(scenario.totalRepaymentAmount)}</td>
                    <td class="no-print"><button class="btn-secondary" onclick="removeScenarioFromComparison(${scenario.id})" aria-label="Remove scenario ${scenario.name}">X</button></td>
                `;
                tableBody.appendChild(row);
            });
        }
        
        // --- Formatting Utilities ---
        function formatCurrency(amount) {
            // Check for NaN or Infinity before formatting
            if (isNaN(amount) || !isFinite(amount)) {
                return "$0.00"; 
            }
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(amount);
        }
        
        // --- Export Functions ---
        function printSummary() {
            window.print();
        }
        
        function exportToPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'pt', 'letter');
            let currentY = 40;
            const margin = 40;
            const pageWidth = doc.internal.pageSize.width;

            doc.setFontSize(18);
            doc.text('Credit Card Repayment Report', pageWidth / 2, currentY, { align: 'center' });
            currentY += 30;

            doc.setFontSize(12);
            doc.text(`Calculated On: ${new Date().toLocaleDateString()}`, margin, currentY);
            currentY += 20;

            // Input Details
            const inputDetails = [
                ["Current Balance", formatCurrency(currentRepaymentResults.currentBalance)],
                ["Annual APR", currentRepaymentResults.apr.toFixed(2) + '%'],
                ["Monthly Payment Input", document.getElementById('monthlyPayment').value === '' ? 'Minimum Payment' : formatCurrency(currentRepaymentResults.monthlyPayment)],
                ["Min. Payment Rate", currentRepaymentResults.minPaymentRate.toFixed(2) + '%'],
                ["Min. Payment Floor", formatCurrency(currentRepaymentResults.minPaymentFloor)]
            ];
            doc.autoTable({
                startY: currentY,
                head: [['Parameter', 'Value']],
                body: inputDetails,
                theme: 'grid',
                headStyles: { fillColor: [52, 152, 219], textColor: 255 },
                styles: { fontSize: 10, cellPadding: 5 },
                margin: { left: margin, right: margin }
            });
            currentY = doc.autoTable.previous.finalY + 20;

            // Summary Results
            const summaryResults = [
                ["Estimated Payoff Time", document.getElementById('payoffTime').textContent],
                ["Total Interest Paid", document.getElementById('totalInterestPaid').textContent],
                ["Total Repayment Amount", document.getElementById('totalRepaymentAmount').textContent],
                ["Actual Monthly Payment", document.getElementById('actualMonthlyPayment').textContent]
            ];
            doc.autoTable({
                startY: currentY,
                head: [['Result', 'Value']],
                body: summaryResults,
                theme: 'grid',
                headStyles: { fillColor: [46, 204, 113], textColor: 255 },
                styles: { fontSize: 10, cellPadding: 5 },
                margin: { left: margin, right: margin }
            });
            currentY = doc.autoTable.previous.finalY + 30;

            // Amortization Schedule
            doc.addPage();
            currentY = margin;
            doc.setFontSize(16);
            doc.text('Detailed Amortization Schedule', pageWidth / 2, currentY, { align: 'center' });
            currentY += 20;

            const scheduleTableData = amortizationSchedule.map(p => [
                p.month,
                p.startingBalance.toFixed(2),
                p.payment.toFixed(2),
                p.interestPaid.toFixed(2),
                p.principalPaid.toFixed(2),
                p.endingBalance.toFixed(2),
                p.cumulativeInterest.toFixed(2),
                p.cumulativePrincipal.toFixed(2)
            ]);

            doc.autoTable({
                startY: currentY,
                head: [['Month', 'Start Bal', 'Payment', 'Interest', 'Principal', 'End Bal', 'Cum. Interest', 'Cum. Principal']],
                body: scheduleTableData,
                theme: 'grid',
                headStyles: { fillColor: [52, 152, 219], textColor: 255 },
                styles: { fontSize: 7, cellPadding: 3 }, // Smaller font/padding for many columns
                margin: { left: margin, right: margin },
                didDrawPage: function(data) {
                    let pageCount = doc.internal.getNumberOfPages();
                    doc.setFontSize(8);
                    doc.text('Page ' + doc.internal.getCurrentPageInfo().pageNumber + ' of ' + pageCount, data.settings.margin.left, doc.internal.pageSize.height - 20);
                }
            });

            // Comparison Table (if any)
            if (comparedScenarios.length > 0) {
                doc.addPage();
                currentY = margin;
                doc.setFontSize(16);
                doc.text('Comparison of Repayment Scenarios', pageWidth / 2, currentY, { align: 'center' });
                currentY += 20;

                const comparisonTableData = comparedScenarios.map(s => [
                    s.name,
                    s.currentBalance.toFixed(2),
                    s.apr.toFixed(2),
                    s.actualMonthlyPayment.toFixed(2),
                    s.payoffTimeFormatted,
                    s.totalInterestPaid.toFixed(2),
                    s.totalRepaymentAmount.toFixed(2)
                ]);

                doc.autoTable({
                    startY: currentY,
                    head: [['Scenario', 'Balance', 'APR (%)', 'Monthly Pmt', 'Payoff Time', 'Total Interest', 'Total Repayment']],
                    body: comparisonTableData,
                    theme: 'grid',
                    headStyles: { fillColor: [52, 152, 219], textColor: 255 },
                    styles: { fontSize: 8, cellPadding: 4 },
                    margin: { left: margin, right: margin },
                    didDrawPage: function(data) {
                        let pageCount = doc.internal.getNumberOfPages();
                        doc.setFontSize(8);
                        doc.text('Page ' + doc.internal.getCurrentPageInfo().pageNumber + ' of ' + pageCount, data.settings.margin.left, doc.internal.pageSize.height - 20);
                    }
                });
            }
            
            doc.save('credit_card_repayment_report.pdf');
        }
        
        function exportToExcel() {
            const wb = XLSX.utils.book_new();
            
            // Sheet 1: Summary
            const summaryData = [
                ["Credit Card Repayment Report", ""],
                ["Calculated On", new Date().toLocaleDateString()],
                [],
                ["Input Details", ""],
                ["Current Balance", currentRepaymentResults.currentBalance],
                ["Annual APR", currentRepaymentResults.apr], // Unformatted for Excel
                ["Monthly Payment Input", currentRepaymentResults.monthlyPayment], // Unformatted input
                ["Min. Payment Rate", currentRepaymentResults.minPaymentRate], // Unformatted
                ["Min. Payment Floor", currentRepaymentResults.minPaymentFloor], // Unformatted
                [],
                ["Results", ""],
                ["Estimated Payoff Time", currentRepaymentResults.payoffTimeFormatted],
                ["Total Interest Paid", currentRepaymentResults.totalInterestPaid], // Unformatted
                ["Total Repayment Amount", currentRepaymentResults.totalRepaymentAmount], // Unformatted
                ["Actual Monthly Payment", currentRepaymentResults.actualMonthlyPayment] // Unformatted
            ];
            const summaryWs = XLSX.utils.aoa_to_sheet(summaryData);
            XLSX.utils.book_append_sheet(wb, summaryWs, "Summary");

            // Sheet 2: Amortization Schedule
            const detailedScheduleHeaders = [
                "Month", "Starting Balance", "Payment", "Interest Paid", 
                "Principal Paid", "Ending Balance", "Cumulative Interest", "Cumulative Principal"
            ];
            const detailedScheduleData = [detailedScheduleHeaders];
            amortizationSchedule.forEach(p => {
                detailedScheduleData.push([
                    p.month,
                    p.startingBalance,
                    p.payment,
                    p.interestPaid,
                    p.principalPaid,
                    p.endingBalance,
                    p.cumulativeInterest,
                    p.cumulativePrincipal
                ]);
            });
            const detailedScheduleWs = XLSX.utils.aoa_to_sheet(detailedScheduleData);
            XLSX.utils.book_append_sheet(wb, detailedScheduleWs, "Amortization Schedule");

            // Sheet 3: Comparison (if any)
            if (comparedScenarios.length > 0) {
                const comparisonHeaders = [
                    "Scenario", "Balance", "APR (%)", "Monthly Pmt", 
                    "Payoff Time", "Total Interest", "Total Repayment"
                ];
                const comparisonData = [comparisonHeaders];
                comparedScenarios.forEach(s => {
                    comparisonData.push([
                        s.name, s.currentBalance, s.apr, s.actualMonthlyPayment,
                        s.payoffTimeFormatted, s.totalInterestPaid, s.totalRepaymentAmount
                    ]);
                });
                const comparisonWs = XLSX.utils.aoa_to_sheet(comparisonData);
                XLSX.utils.book_append_sheet(wb, comparisonWs, "Comparison");
            }
            
            XLSX.writeFile(wb, 'credit_card_repayment_report.xlsx');
        }
        
        function exportToCSV() {
            let csvContent = "";

            // Summary data
            csvContent += "Credit Card Repayment Report\n";
            csvContent += `"Calculated On","${new Date().toLocaleDateString()}"\n\n`;
            csvContent += `"Input Details",\n`;
            csvContent += `"Current Balance",${currentRepaymentResults.currentBalance}\n`;
            csvContent += `"Annual APR",${currentRepaymentResults.apr}%\n`; // Formatted for CSV
            csvContent += `"Monthly Payment Input",${currentRepaymentResults.monthlyPayment === null ? 'Minimum Payment' : currentRepaymentResults.monthlyPayment}\n`;
            csvContent += `"Min. Payment Rate",${currentRepaymentResults.minPaymentRate}%\n`; // Formatted for CSV
            csvContent += `"Min. Payment Floor",${currentRepaymentResults.minPaymentFloor}\n\n`;
            csvContent += `"Results",\n`;
            csvContent += `"Estimated Payoff Time","${currentRepaymentResults.payoffTimeFormatted}"\n`; // Formatted for CSV
            csvContent += `"Total Interest Paid",${currentRepaymentResults.totalInterestPaid.toFixed(2)}\n`; // Formatted for CSV
            csvContent += `"Total Repayment Amount",${currentRepaymentResults.totalRepaymentAmount.toFixed(2)}\n`; // Formatted for CSV
            csvContent += `"Actual Monthly Payment",${currentRepaymentResults.actualMonthlyPayment.toFixed(2)}\n\n`; // Formatted for CSV

            // Amortization Schedule
            csvContent += "Amortization Schedule\n";
            csvContent += "Month,Starting Balance,Payment,Interest Paid,Principal Paid,Ending Balance,Cumulative Interest,Cumulative Principal\n";
            amortizationSchedule.forEach(p => {
                csvContent += `${p.month},${p.startingBalance.toFixed(2)},${p.payment.toFixed(2)},${p.interestPaid.toFixed(2)},${p.principalPaid.toFixed(2)},${p.endingBalance.toFixed(2)},${p.cumulativeInterest.toFixed(2)},${p.cumulativePrincipal.toFixed(2)}\n`;
            });
            csvContent += "\n";

            // Comparison (if any)
            if (comparedScenarios.length > 0) {
                csvContent += "Comparison\n";
                csvContent += "Scenario,Balance,APR (%),Monthly Pmt,Payoff Time,Total Interest,Total Repayment\n";
                comparedScenarios.forEach(s => {
                    csvContent += `"${s.name}",${s.currentBalance.toFixed(2)},${s.apr.toFixed(2)},${s.actualMonthlyPayment.toFixed(2)},"${s.payoffTimeFormatted}",${s.totalInterestPaid.toFixed(2)},${s.totalRepaymentAmount.toFixed(2)}\n`;
                });
                csvContent += "\n";
            }

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', 'credit_card_repayment_report.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function exportToTXT() {
            let txtContent = "";

            txtContent += "Credit Card Repayment Report\n\n";
            txtContent += "Calculated On: " + new Date().toLocaleDateString() + "\n\n";

            txtContent += "--- Input Details ---\n";
            txtContent += `Current Balance: ${formatCurrency(currentRepaymentResults.currentBalance)}\n`;
            txtContent += `Annual APR: ${currentRepaymentResults.apr.toFixed(2)}%\n`;
            txtContent += `Monthly Payment Input: ${currentRepaymentResults.monthlyPayment === null ? 'Minimum Payment' : formatCurrency(currentRepaymentResults.monthlyPayment)}\n`;
            txtContent += `Min. Payment Rate: ${currentRepaymentResults.minPaymentRate.toFixed(2)}%\n`;
            txtContent += `Min. Payment Floor: ${formatCurrency(currentRepaymentResults.minPaymentFloor)}\n\n`;

            txtContent += "--- Summary Results ---\n";
            txtContent += `Estimated Payoff Time: ${currentRepaymentResults.payoffTimeFormatted}\n`;
            txtContent += `Total Interest Paid: ${formatCurrency(currentRepaymentResults.totalInterestPaid)}\n`;
            txtContent += `Total Repayment Amount: ${formatCurrency(currentRepaymentResults.totalRepaymentAmount)}\n`;
            txtContent += `Actual Monthly Payment: ${formatCurrency(currentRepaymentResults.actualMonthlyPayment)}\n\n`;

            txtContent += "--- Amortization Schedule ---\n";
            txtContent += "Month | Start Bal | Payment   | Interest  | Principal | End Bal   | Cum. Int. | Cum. Prin.\n";
            txtContent += "------|-----------|-----------|-----------|-----------|-----------|-----------|-----------\n";
            amortizationSchedule.forEach(p => {
                const row = [
                    String(p.month).padEnd(5),
                    formatCurrency(p.startingBalance).padEnd(9),
                    formatCurrency(p.payment).padEnd(9),
                    formatCurrency(p.interestPaid).padEnd(9),
                    formatCurrency(p.principalPaid).padEnd(9),
                    formatCurrency(p.endingBalance).padEnd(9),
                    formatCurrency(p.cumulativeInterest).padEnd(9),
                    formatCurrency(p.cumulativePrincipal)
                ];
                txtContent += row.join(' | ') + '\n';
            });

            if (comparedScenarios.length > 0) {
                txtContent += "\n--- Comparison of Repayment Scenarios ---\n";
                txtContent += "Scenario   | Balance   | APR (%) | Monthly Pmt | Payoff Time   | Total Interest | Total Repayment\n";
                txtContent += "-----------|-----------|---------|-------------|---------------|----------------|----------------\n";
                comparedScenarios.forEach(s => {
                    const row = [
                        String(s.name).padEnd(10),
                        formatCurrency(s.currentBalance).padEnd(9),
                        String(s.apr.toFixed(2) + '%').padEnd(7),
                        formatCurrency(s.actualMonthlyPayment).padEnd(11),
                        String(s.payoffTimeFormatted).padEnd(13),
                        formatCurrency(s.totalInterestPaid).padEnd(14),
                        formatCurrency(s.totalRepaymentAmount)
                    ];
                    txtContent += row.join(' | ') + '\n';
                });
            }

            const blob = new Blob([txtContent], { type: 'text/plain;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', 'credit_card_repayment_report.txt');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // --- Share Link Logic ---
        function generateShareLink() {
            const dataToShare = {
                cb: document.getElementById('currentBalance').value,
                ap: document.getElementById('apr').value,
                mp: document.getElementById('monthlyPayment').value,
                mpr: document.getElementById('minPaymentRate').value,
                mpf: document.getElementById('minPaymentFloor').value
            };
            const jsonString = JSON.stringify(dataToShare);
            const encodedData = btoa(encodeURIComponent(jsonString)); // Base64 encode after URI encoding
            const shareUrl = `${window.location.origin}${window.location.pathname}?data=${encodedData}`;
            return shareUrl;
        }

        function copyShareLink() {
            const shareUrl = generateShareLink();
            navigator.clipboard.writeText(shareUrl).then(() => {
                alert('Share link copied to clipboard!');
            }).catch(err => {
                console.error('Failed to copy share link: ', err);
                alert('Failed to copy link. Please copy manually: ' + shareUrl);
            });
        }

        function decodeShareLink() {
            const urlParams = new URLSearchParams(window.location.search);
            const encodedData = urlParams.get('data');
            if (encodedData) {
                try {
                    const decodedJsonString = decodeURIComponent(atob(encodedData)); // Decode URI then Base64
                    const sharedData = JSON.parse(decodedJsonString);
                    
                    document.getElementById('currentBalance').value = sharedData.cb || 0;
                    document.getElementById('apr').value = sharedData.ap || 0;
                    document.getElementById('monthlyPayment').value = sharedData.mp || ''; // Use '' for optional
                    document.getElementById('minPaymentRate').value = sharedData.mpr || MIN_PAYMENT_RATE_DEFAULT;
                    document.getElementById('minPaymentFloor').value = sharedData.mpf || MIN_PAYMENT_FLOOR_DEFAULT;
                    
                    // Remove data parameter from URL to prevent re-decoding on refresh
                    const newUrl = new URL(window.location.href);
                    newUrl.searchParams.delete('data');
                    window.history.replaceState({}, document.title, newUrl.toString());

                    calculatePayoff(); // Recalculate based on shared link's data
                } catch (e) {
                    console.error("Failed to decode share link parameters:", e);
                    showError('currentBalance-error', 'Invalid share link detected. Please check the URL or try new calculation.');
                }
            }
        }

        function setupSocialSharing() {
            const balance = currentRepaymentResults.currentBalance || 0;
            const apr = currentRepaymentResults.apr || 0;
            const payoffTime = currentRepaymentResults.payoffTimeFormatted || 'N/A';
            const totalInterest = currentRepaymentResults.totalInterestPaid || 0;
            const totalRepayment = currentRepaymentResults.totalRepaymentAmount || 0;
            const monthlyPmt = currentRepaymentResults.actualMonthlyPayment || 0;

            const shareUrl = generateShareLink(); 

            let shareText = `I analyzed my credit card debt! For a ${formatCurrency(balance)} balance at ${apr.toFixed(2)}% APR, with monthly payments of ${formatCurrency(monthlyPmt)}, I can pay it off in ${payoffTime}! Total interest: ${formatCurrency(totalInterest)}. Total repayment: ${formatCurrency(totalRepayment)}. Analyze yours here:`;
            
            document.getElementById('emailShare').onclick = () => {
                window.open(`mailto:?subject=Credit Card Debt Repayment Analysis&body=${encodeURIComponent(shareText + ' ' + shareUrl)}`);
            };
            document.getElementById('whatsappShare').onclick = () => {
                window.open(`https://wa.me/?text=${encodeURIComponent(shareText + ' ' + shareUrl)}`);
            };
            document.getElementById('linkedinShare').onclick = () => {
                window.open(`https://www.linkedin.com/shareArticle?mini=true&url=${encodeURIComponent(shareUrl)}&title=${encodeURIComponent('Credit Card Debt Repayment Calculator')}&summary=${encodeURIComponent(shareText)}`);
            };
            document.getElementById('twitterShare').onclick = () => {
                window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(shareText)}&url=${encodeURIComponent(shareUrl)}`);
            };
        }
    </script>
</body>
</html>