<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Professional Commission Calculator</title>
    <!-- 
        Content-Security-Policy: For production deployment, configure this via your web server (e.g., Nginx, Apache) 
        for best practice. If using a meta tag, ensure all CDN domains (Chart.js, jsPDF, SheetJS) are whitelisted.
        For this single-file, self-contained solution, inline scripts/styles require 'unsafe-inline'.
        Example for meta (adjust for your specific ad networks if they inject more):
        <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' cdnjs.cloudflare.com cdn.jsdelivr.net cdn.sheetjs.com; style-src 'self' 'unsafe-inline'; img-src * data:; media-src *; connect-src *;">
    -->
    
    <!-- External Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>

    <style>
        /* CSS Variables for theming */
        :root {
            --primary: #3498db;
            --secondary: #2ecc71;
            --danger: #e74c3c;
            --dark-heading-bg: #2c3e50; /* Used for table headers in light mode */
            --light-bg-secondary: #ecf0f1; /* Used for ad containers, tab non-active */
            --text-color: #333;
            --bg-color: #f9f9f9;
            --card-bg: #fff;
            --border-color: #ddd;
            --chart-color-net: #3498db; /* Blue */
            --chart-color-tax: #e74c3c; /* Red */
        }
        
        /* Dark Theme Variables */
        [data-theme="dark"] {
            --primary: #2980b9;
            --secondary: #27ae60;
            --danger: #c0392b;
            --dark-heading-bg: #34495e; /* Adjusted for dark mode table headers */
            --light-bg-secondary: #4a667e; /* Adjusted for dark mode ad containers/tabs */
            --text-color: #ecf0f1;
            --bg-color: #2c3e50;
            --card-bg: #34495e;
            --border-color: #555;
            --chart-color-net: #4a90e2; 
            --chart-color-tax: #ff6b6b;
        }
        
        /* Global Styles */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: var(--text-color);
            background-color: var(--bg-color);
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            transition: all 0.3s ease; /* Smooth transition for theme change */
        }
        
        .calculator-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }
        
        @media (min-width: 768px) {
            .calculator-container {
                grid-template-columns: 1fr 1fr;
            }
        }
        
        .input-section, .results-section {
            background: var(--card-bg);
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        h1, h2, h3 {
            color: var(--primary);
        }
        
        .input-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }
        
        input, select {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 16px;
            background-color: var(--card-bg);
            color: var(--text-color);
            transition: border-color 0.3s, background-color 0.3s, color 0.3s;
        }
        
        /* Buttons */
        button {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        
        button:hover {
            background-color: var(--secondary);
        }

        .btn-secondary {
            background-color: #6c757d;
        }

        .btn-secondary:hover {
            background-color: #5a6268;
        }
        
        /* Ad Containers */
        .ad-container {
            margin: 20px 0;
            padding: 15px;
            background: var(--light-bg-secondary);
            border-radius: 4px;
            text-align: center;
            min-height: 90px;
            color: var(--text-color);
            display: flex; /* For centering text */
            align-items: center;
            justify-content: center;
            flex-direction: column;
            border: 1px dashed var(--border-color);
        }
        
        .chart-container {
            height: 300px;
            margin: 20px 0;
        }
        
        /* Summary Cards */
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .summary-card {
            background: var(--card-bg);
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            text-align: center;
            transition: background-color 0.3s, box-shadow 0.3s;
        }
        
        .summary-card h3 {
            margin-top: 0;
            font-size: 16px;
            color: var(--text-color); /* Use theme variable */
        }
        
        .summary-card p {
            font-size: 24px;
            font-weight: bold;
            margin: 10px 0;
            color: var(--primary); /* Use primary color */
        }
        
        /* Tables */
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            color: var(--text-color);
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }
        
        th {
            background-color: var(--dark-heading-bg); /* Use dark card bg for table headers */
            color: white;
        }
        
        tr:hover {
            background-color: rgba(0,0,0,0.05); /* Light mode hover */
        }
        [data-theme="dark"] tr:hover {
            background-color: rgba(255,255,255,0.05); /* Dark mode hover */
        }
        
        /* Tooltips */
        .tooltip {
            position: relative;
            display: inline-block;
            cursor: help;
            color: var(--primary);
            font-size: 0.9em;
            margin-left: 5px;
        }
        
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 250px; /* Wider for more text */
            background-color: var(--dark-heading-bg);
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 10px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 14px;
            font-weight: normal;
        }
        
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
        
        /* Export & Share Options */
        .export-options, .social-sharing {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin: 20px 0;
        }
        
        .social-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 8px 12px;
            border-radius: 4px;
            color: white;
            text-decoration: none;
            font-size: 14px;
            transition: opacity 0.3s;
        }
        .social-btn:hover {
            opacity: 0.8;
        }
        
        .email { background-color: #777; }
        .whatsapp { background-color: #25D366; }
        .linkedin { background-color: #0077B5; }
        .twitter { background-color: #1DA1F2; }
        
        /* Theme Toggle Button */
        .theme-toggle {
            position: absolute; 
            top: 20px;
            right: 20px;
            background: var(--primary);
            color: white;
            border: none;
            padding: 10px;
            border-radius: 50%;
            cursor: pointer;
            z-index: 1000;
            font-size: 1.2em;
            width: 40px; /* Fixed width/height for round button */
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: background-color 0.3s, box-shadow 0.3s;
        }
        
        /* Error Messages */
        .error-message {
            color: var(--danger);
            font-size: 0.9em;
            margin-top: 5px;
        }

        /* How to Use / Disclaimer Section */
        .info-section {
            background: var(--card-bg);
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-top: 20px;
        }
        .info-section h2 {
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: var(--text-color); /* Ensure heading matches text color */
        }
        .info-content {
            display: none;
            color: var(--text-color); /* Ensure content matches text color */
        }
        .info-content.active {
            display: block;
        }
        .info-section p {
            margin-bottom: 10px;
        }
        .info-section ul {
            list-style-type: disc;
            margin-left: 20px;
            margin-bottom: 10px;
        }
        .info-section li {
            margin-bottom: 5px;
        }

        /* Tiered Commission Table */
        .tier-table-container {
            margin-top: 20px;
            margin-bottom: 15px;
        }
        .tier-table {
            width: 100%;
            border-collapse: collapse;
        }
        .tier-table th, .tier-table td {
            padding: 8px;
            border: 1px solid var(--border-color);
            text-align: left;
        }
        .tier-table th {
            background-color: var(--light-bg-secondary);
            color: var(--text-color);
        }
        .tier-table input[type="number"] {
            width: 100%;
            padding: 6px;
            font-size: 14px;
        }
        .remove-tier-btn {
            background-color: var(--danger);
            padding: 5px 10px;
            font-size: 14px;
        }
        .add-tier-btn {
            margin-top: 10px;
            background-color: var(--secondary);
        }
        .add-tier-btn:hover {
            background-color: #27ae60;
        }

        /* Print Specific Styles */
        @media print {
            .no-print, .ad-container, .theme-toggle, .info-section, .export-options, .social-sharing, .tier-table .remove-tier-btn, .add-tier-btn {
                display: none !important;
            }
            body {
                background: none;
                padding: 0;
                color: black; /* Force black text for print */
            }
            .calculator-container {
                display: block;
            }
            .input-section {
                display: none; /* Hide input section in print */
            }
            .results-section {
                box-shadow: none; /* Remove shadow for print */
                padding: 0;
            }
            table {
                font-size: 10px; /* Smaller font for print tables */
                color: black;
            }
            th, td {
                padding: 8px;
                border-color: #ccc; /* Lighter border for print */
            }
            th {
                background-color: #eee !important; /* Lighter header for print */
                color: black !important;
            }
            tr:hover {
                background-color: transparent !important;
            }
            .chart-container canvas {
                max-width: 500px; /* Constrain chart size for print */
                max-height: 300px;
                display: block; /* Ensure chart is block level for print */
                margin: 0 auto;
            }
            .summary-card h3, .summary-card p {
                color: black !important; /* Ensure readable colors in print */
            }
        }
    </style>
</head>
<body>
    <button class="theme-toggle no-print" id="themeToggle" aria-label="Toggle dark/light mode">🌓</button>
    
    <h1>Professional Commission Calculator</h1>
    
    <div class="calculator-container">
        <div class="input-section">
            <h2>Sales & Commission Structure</h2>
            
            <div class="input-group">
                <label for="totalSales">
                    Total Sales Amount ($)
                    <span class="tooltip">ℹ️
                        <span class="tooltiptext">
                            The total sales generated on which commission will be calculated.
                        </span>
                    </span>
                </label>
                <input type="number" id="totalSales" min="0" step="100" value="100000" aria-describedby="totalSales-error">
                <div class="error-message" id="totalSales-error" role="alert" aria-live="polite"></div>
            </div>
            
            <div class="input-group">
                <label for="taxRate">
                    Tax Deduction Rate (%)
                    <span class="tooltip">ℹ️
                        <span class="tooltiptext">
                            The percentage of your gross commission that will be deducted for taxes or other fees.
                        </span>
                    </span>
                </label>
                <input type="number" id="taxRate" min="0" max="100" step="0.01" value="20" aria-describedby="taxRate-error">
                <div class="error-message" id="taxRate-error" role="alert" aria-live="polite"></div>
            </div>

            <h3>Commission Tiers</h3>
            <div class="tier-table-container">
                <table class="tier-table" id="commissionTierTable">
                    <thead>
                        <tr>
                            <th>Sales Threshold ($)</th>
                            <th>Commission Rate (%)</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody id="commissionTierTableBody">
                        <tr>
                            <td><input type="number" class="tier-threshold" min="0" step="100" value="0" aria-label="Sales Threshold"></td>
                            <td><input type="number" class="tier-rate" min="0" max="100" step="0.01" value="5" aria-label="Commission Rate"></td>
                            <td><button class="remove-tier-btn" aria-label="Remove Tier">X</button></td>
                        </tr>
                        <tr>
                            <td><input type="number" class="tier-threshold" min="0" step="100" value="50000" aria-label="Sales Threshold"></td>
                            <td><input type="number" class="tier-rate" min="0" max="100" step="0.01" value="7.5" aria-label="Commission Rate"></td>
                            <td><button class="remove-tier-btn" aria-label="Remove Tier">X</button></td>
                        </tr>
                        <tr>
                            <td><input type="number" class="tier-threshold" min="0" step="100" value="100000" aria-label="Sales Threshold"></td>
                            <td><input type="number" class="tier-rate" min="0" max="100" step="0.01" value="10" aria-label="Commission Rate"></td>
                            <td><button class="remove-tier-btn" aria-label="Remove Tier">X</button></td>
                        </tr>
                    </tbody>
                </table>
                <button class="add-tier-btn" id="addTierBtn" aria-label="Add New Commission Tier">Add Tier</button>
                <div class="error-message" id="tier-error" role="alert" aria-live="polite"></div>
            </div>
            
            <button id="calculateBtn">Calculate Commissions</button>
        </div>
        
        <div class="results-section">
            <h2>Commission Summary</h2>
            
            <div class="summary-cards">
                <div class="summary-card">
                    <h3>Gross Commission</h3>
                    <p id="grossCommission">$0.00</p>
                </div>
                <div class="summary-card">
                    <h3>Tax Deduction</h3>
                    <p id="taxDeduction">$0.00</p>
                </div>
                <div class="summary-card">
                    <h3>Net Commission</h3>
                    <p id="netCommission">$0.00</p>
                </div>
                <div class="summary-card">
                    <h3>Total Earnings</h3>
                    <p id="totalEarnings">$0.00</p>
                </div>
            </div>
            
            <div class="chart-container">
                <canvas id="commissionBreakdownChart" aria-label="Commission Breakdown Chart"></canvas>
            </div>
            
            <h3>Detailed Commission Breakdown</h3>
            <div style="overflow-x: auto;">
                <table id="commissionBreakdownTable">
                    <thead>
                        <tr>
                            <th>Sales Segment</th>
                            <th>Rate Applied</th>
                            <th>Commission Earned</th>
                        </tr>
                    </thead>
                    <tbody id="commissionBreakdownTableBody">
                        <!-- Will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>
            
            <div class="ad-container">
                <!-- Adsterra Responsive Banner Ad Code Here -->
                Advertisement Space (Adsterra Responsive Banner)
                <small>This space is reserved for ad network code (e.g., 728x90).</small>
            </div>

            <div class="export-options no-print">
                <button id="printBtn">Print Summary</button>
                <button id="pdfBtn">Save as PDF</button>
                <button id="excelBtn">Save as Excel</button>
                <button id="csvBtn">Save as CSV</button>
                <button id="txtBtn">Save as TXT</button>
            </div>
            
            <div class="social-sharing no-print">
                <button class="social-btn email" id="emailShare" aria-label="Share via Email">Email</button>
                <button class="social-btn whatsapp" id="whatsappShare" aria-label="Share via WhatsApp">WhatsApp</button>
                <button class="social-btn linkedin" id="linkedinShare" aria-label="Share via LinkedIn">LinkedIn</button>
                <button class="social-btn twitter" id="twitterShare" aria-label="Share via Twitter">Twitter</button>
                <button class="social-btn btn-secondary" id="shareLink" aria-label="Copy Shareable Link">Copy Share Link</button>
            </div>

            <div class="ad-container" style="height: 250px;">
                <!-- Yllix Sidebar/Floating Ad Code Here -->
                Advertisement Space (Yllix Sidebar/Floating)
                <small>This space is reserved for ad network code (e.g., 300x250).</small>
            </div>
        </div>
    </div>

    <div class="info-section">
        <h2 id="howToUseToggle" aria-expanded="false" aria-controls="howToUseContent">
            How to Use This Calculator <span aria-hidden="true">▼</span>
        </h2>
        <div class="info-content" id="howToUseContent">
            <p>This calculator helps you determine your gross and net commission earnings based on your total sales and a tiered commission structure.</p>
            <ul>
                <li><strong>Total Sales Amount:</strong> Enter the total sales value you've generated.</li>
                <li><strong>Tax Deduction Rate (%):</strong> Input the percentage of your gross commission that will be deducted for taxes, fees, or other withholdings.</li>
                <li><strong>Commission Tiers:</strong> This is where you define your commission structure:
                    <ul>
                        <li><strong>Sales Threshold ($):</strong> The sales amount at which a new commission rate applies. The first tier should always start at $0.</li>
                        <li><strong>Commission Rate (%):</strong> The percentage commission earned on the sales amount *within that specific tier's range*.</li>
                        <li>Use "Add Tier" to add more rows, and "X" to remove a tier. Ensure your tiers are sorted by threshold from lowest to highest.</li>
                    </ul>
                </li>
            </ul>
            <p><strong>What the Results Mean:</strong></p>
            <ul>
                <li><strong>Gross Commission:</strong> The total commission earned before any deductions.</li>
                <li><strong>Tax Deduction:</strong> The amount deducted from your gross commission based on the tax rate.</li>
                <li><strong>Net Commission:</strong> Your commission after the tax deduction.</li>
                <li><strong>Total Earnings:</strong> This represents your total income including your sales amount and net commission.</li>
            </ul>
            <p style="font-style: italic; color: var(--danger);"><strong>Disclaimer:</strong> This calculator provides estimates based on your inputs. Actual commission structures and tax laws vary widely. It is for informational purposes only and should not be considered financial or tax advice. Consult your employer, compensation plan, or a qualified tax professional for precise calculations and guidance.</p>
        </div>
    </div>

    <script>
        // Global variables to store calculation results and chart instance
        let currentCommissionResults = {};
        let detailedCommissionBreakdown = []; // Stores details for table and export
        let commissionBreakdownChartInstance = null; // To manage Chart.js instance

        document.addEventListener('DOMContentLoaded', function() {
            // Set up theme toggle
            // Fix: Corrected localStorage access
            const savedTheme = localStorage.getItem('theme') || 'light'; 
            document.documentElement.setAttribute('data-theme', savedTheme);
            document.getElementById('themeToggle').addEventListener('click', toggleTheme);
            
            // Set up event listeners for tier table rows
            document.getElementById('addTierBtn').addEventListener('click', addTierRow);
            // Event delegation for remove buttons on the table body
            document.getElementById('commissionTierTableBody').addEventListener('click', function(event) {
                if (event.target.classList.contains('remove-tier-btn')) {
                    removeTierRow(event);
                }
            });

            // Set up main calculation and export buttons
            document.getElementById('calculateBtn').addEventListener('click', calculateCommissions);
            document.getElementById('printBtn').addEventListener('click', printSummary);
            document.getElementById('pdfBtn').addEventListener('click', exportToPDF);
            document.getElementById('excelBtn').addEventListener('click', exportToExcel);
            document.getElementById('csvBtn').addEventListener('click', exportToCSV);
            document.getElementById('txtBtn').addEventListener('click', exportToTXT);
            document.getElementById('shareLink').addEventListener('click', copyShareLink);

            // Set up how-to-use toggle
            const howToUseToggle = document.getElementById('howToUseToggle');
            const howToUseContent = document.getElementById('howToUseContent');
            howToUseToggle.addEventListener('click', function() {
                const isExpanded = this.getAttribute('aria-expanded') === 'true';
                this.setAttribute('aria-expanded', !isExpanded);
                howToUseContent.classList.toggle('active');
                howToUseToggle.querySelector('span').textContent = isExpanded ? '▼' : '▲';
            });
            // Initial state for how-to-use
            howToUseContent.classList.remove('active');
            howToUseToggle.setAttribute('aria-expanded', 'false');
            howToUseToggle.querySelector('span').textContent = '▼';

            // Decode share link parameters on page load if present
            decodeShareLink();
            
            // Initial calculation to populate the UI (from default values or decoded link)
            calculateCommissions();
            setupSocialSharing(); // Needs initial data
        });
        
        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            if (currentTheme === 'dark') {
                document.documentElement.setAttribute('data-theme', 'light');
                localStorage.setItem('theme', 'light');
            } else {
                document.documentElement.setAttribute('data-theme', 'dark');
                localStorage.setItem('theme', 'dark');
            }
            // Update chart colors on theme change
            if (commissionBreakdownChartInstance) {
                const rootStyle = getComputedStyle(document.documentElement);
                commissionBreakdownChartInstance.data.datasets[0].backgroundColor = [
                    rootStyle.getPropertyValue('--chart-color-net'),
                    rootStyle.getPropertyValue('--chart-color-tax')
                ];
                commissionBreakdownChartInstance.options.plugins.legend.labels.color = rootStyle.getPropertyValue('--text-color');
                commissionBreakdownChartInstance.options.plugins.title.color = rootStyle.getPropertyValue('--text-color');
                commissionBreakdownChartInstance.update();
            }
        }
        
        // --- Error Handling Utilities ---
        function clearErrors() {
            document.querySelectorAll('.error-message').forEach(el => el.textContent = '');
        }

        function showError(elementId, message) {
            document.getElementById(elementId).textContent = message;
        }

        // --- Dynamic Tier Management ---
        function addTierRow() {
            const tableBody = document.getElementById('commissionTierTableBody');
            const newRow = tableBody.insertRow();
            // Default values for new row to aid user
            const defaultThreshold = commissionTiers.length > 0 ? commissionTiers[commissionTiers.length - 1].threshold + 1000 : 0;
            const defaultRate = commissionTiers.length > 0 ? commissionTiers[commissionTiers.length - 1].rate * 100 : 0;

            newRow.innerHTML = `
                <td><input type="number" class="tier-threshold" min="0" step="100" value="${defaultThreshold}" aria-label="Sales Threshold"></td>
                <td><input type="number" class="tier-rate" min="0" max="100" step="0.01" value="${defaultRate}" aria-label="Commission Rate"></td>
                <td><button class="remove-tier-btn" aria-label="Remove Tier">X</button></td>
            `;
            // No need to add specific event listener here, as it's handled by delegation on table body
        }

        function removeTierRow(event) {
            // Ensure at least one tier remains
            const tableBody = document.getElementById('commissionTierTableBody');
            if (tableBody.rows.length <= 1) {
                showError('tier-error', 'At least one commission tier is required.');
                return;
            }
            event.target.closest('tr').remove();
            calculateCommissions(); // Recalculate after removing a row
        }
        
        // --- Core Commission Calculation Logic ---
        function calculateCommissions() {
            clearErrors(); // Clear previous errors

            const totalSales = parseFloat(document.getElementById('totalSales').value);
            let taxRate = parseFloat(document.getElementById('taxRate').value);
            taxRate /= 100; // Convert to decimal

            let isValid = true;
            if (isNaN(totalSales) || totalSales < 0) {
                showError('totalSales-error', 'Must be a non-negative number.'); isValid = false;
            }
            if (isNaN(taxRate) || taxRate < 0 || taxRate > 1) { // 0-100%
                showError('taxRate-error', 'Must be between 0% and 100%.'); isValid = false;
            }

            // Read and validate commission tiers
            const tierRows = document.querySelectorAll('#commissionTierTableBody tr');
            let commissionTiers = []; // Local variable for this calculation instance
            
            for (let i = 0; i < tierRows.length; i++) {
                const row = tierRows[i];
                const thresholdInput = row.querySelector('.tier-threshold');
                const rateInput = row.querySelector('.tier-rate');

                const threshold = parseFloat(thresholdInput.value);
                const rate = parseFloat(rateInput.value);

                if (isNaN(threshold) || threshold < 0) {
                    showError('tier-error', `Tier ${i + 1}: Sales Threshold must be a non-negative number.`); isValid = false;
                }
                if (isNaN(rate) || rate < 0 || rate > 100) {
                    showError('tier-error', `Tier ${i + 1}: Commission Rate must be between 0% and 100%.`); isValid = false;
                }
                commissionTiers.push({ threshold: threshold, rate: rate / 100 }); // Store rate as decimal
            }

            if (!isValid) {
                document.getElementById('results-section').style.display = 'none';
                return;
            }

            // Sort tiers by threshold to ensure correct calculation
            commissionTiers.sort((a, b) => a.threshold - b.threshold);

            // Validate tier structure (no duplicate thresholds, first must be 0, ascending order)
            if (commissionTiers.length === 0) {
                showError('tier-error', 'At least one commission tier is required.'); isValid = false;
            } else {
                if (commissionTiers[0].threshold !== 0) {
                    showError('tier-error', 'The first commission tier must start at a sales threshold of $0.'); isValid = false;
                }
                for (let i = 1; i < commissionTiers.length; i++) {
                    if (commissionTiers[i].threshold <= commissionTiers[i-1].threshold) {
                        showError('tier-error', `Tier ${i+1} threshold (${commissionTiers[i].threshold}) must be greater than Tier ${i} threshold (${commissionTiers[i-1].threshold}). Please sort or adjust thresholds.`); isValid = false;
                    }
                }
            }

            if (!isValid) {
                document.getElementById('results-section').style.display = 'none';
                return;
            }

            // --- Core Commission Calculation Algorithm ---
            let grossCommission = 0;
            let salesProcessed = 0; // Track sales already covered by previous tiers
            detailedCommissionBreakdown = []; // Reset for new calculation

            for (let i = 0; i < commissionTiers.length; i++) {
                const currentTier = commissionTiers[i];
                const nextTierThreshold = (i + 1 < commissionTiers.length) ? commissionTiers[i + 1].threshold : Infinity;

                // Determine the sales segment for this tier
                const tierSegmentStart = Math.max(salesProcessed, currentTier.threshold);
                const tierSegmentEnd = Math.min(totalSales, nextTierThreshold);

                // If sales processed has passed this tier's start, or totalSales is below this tier's start, continue
                if (totalSales <= tierSegmentStart) {
                     continue; // Sales don't reach this tier, or already processed higher tiers
                }
                if (tierSegmentEnd <= tierSegmentStart) {
                    continue; // No sales within this segment
                }

                const salesInCurrentSegment = tierSegmentEnd - tierSegmentStart;
                const commissionForSegment = salesInCurrentSegment * currentTier.rate;
                
                grossCommission += commissionForSegment;

                detailedCommissionBreakdown.push({
                    segment: `${formatCurrency(tierSegmentStart)} - ${nextTierThreshold === Infinity ? 'Above' : formatCurrency(tierSegmentEnd)}`,
                    salesApplied: salesInCurrentSegment,
                    rate: currentTier.rate * 100, // Store as percentage for display
                    commissionEarned: commissionForSegment
                });

                salesProcessed = tierSegmentEnd; // Update sales processed up to the end of this segment
            }

            const taxDeduction = grossCommission * taxRate;
            const netCommission = grossCommission - taxDeduction;
            const totalEarnings = totalSales + netCommission; // Total cash received (sales handled + net commission)

            // Validate final calculated values
            if (isNaN(grossCommission) || !isFinite(grossCommission)) {
                showError('totalSales-error', 'Calculation resulted in invalid numbers. Check inputs or tier rates.');
                document.getElementById('results-section').style.display = 'none';
                return;
            }

            // Store results in global object
            currentCommissionResults = {
                totalSales: totalSales,
                taxRate: taxRate * 100, // Store as percentage for display
                grossCommission: grossCommission,
                taxDeduction: taxDeduction,
                netCommission: netCommission,
                totalEarnings: totalEarnings
            };

            // Update UI
            updateSummaryCards(currentCommissionResults);
            updateChart(currentCommissionResults);
            displayCommissionBreakdownTable(detailedCommissionBreakdown);
            setupSocialSharing(); // Update sharing links with new data

            document.getElementById('results-section').style.display = 'block';
        }

        // --- UI Update Functions ---
        function updateSummaryCards(results) {
            document.getElementById('grossCommission').textContent = formatCurrency(results.grossCommission);
            document.getElementById('taxDeduction').textContent = formatCurrency(results.taxDeduction);
            document.getElementById('netCommission').textContent = formatCurrency(results.netCommission);
            document.getElementById('totalEarnings').textContent = formatCurrency(results.totalEarnings);
        }
        
        function updateChart(results) {
            const ctx = document.getElementById('commissionBreakdownChart').getContext('2d');
            
            // Destroy previous chart if exists
            if (commissionBreakdownChartInstance) {
                commissionBreakdownChartInstance.destroy();
            }

            if (results.grossCommission <= 0) { // No meaningful data to chart
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                return;
            }

            const labels = ['Net Commission', 'Tax Deduction'];
            const data = [results.netCommission, results.taxDeduction];

            // Filter out zero values for chart if they are not relevant for visual representation
            const filteredLabels = [];
            const filteredData = [];
            const backgroundColors = [];
            const rootStyle = getComputedStyle(document.documentElement);
            const chartColors = [
                rootStyle.getPropertyValue('--chart-color-net'),
                rootStyle.getPropertyValue('--chart-color-tax')
            ];

            for(let i = 0; i < data.length; i++) {
                if (Math.abs(data[i]) > 0.01) { // Filter out very small values (near zero)
                    filteredData.push(data[i]);
                    filteredLabels.push(labels[i]);
                    backgroundColors.push(chartColors[i]);
                }
            }

            commissionBreakdownChartInstance = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: filteredLabels,
                    datasets: [{
                        data: filteredData,
                        backgroundColor: backgroundColors,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                color: rootStyle.getPropertyValue('--text-color')
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.raw;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                                    return `${context.label}: ${formatCurrency(value)} (${percentage}%)`;
                                }
                            }
                        },
                        title: {
                            display: true,
                            text: `Gross Commission Breakdown (Total: ${formatCurrency(results.grossCommission)})`,
                            color: rootStyle.getPropertyValue('--text-color')
                        }
                    }
                }
            });
        }

        function displayCommissionBreakdownTable(breakdown) {
            const tableBody = document.getElementById('commissionBreakdownTableBody');
            tableBody.innerHTML = '';
            
            if (breakdown.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="3" style="text-align: center;">No commission breakdown available.</td></tr>';
                return;
            }

            breakdown.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item.segment}</td>
                    <td>${formatPercentage(item.rate)}</td>
                    <td>${formatCurrency(item.commissionEarned)}</td>
                `;
                tableBody.appendChild(row);
            });
        }
        
        // --- Formatting Utilities ---
        function formatCurrency(amount) {
            // Check for NaN or Infinity before formatting
            if (isNaN(amount) || !isFinite(amount)) {
                return "$0.00"; 
            }
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(amount);
        }

        function formatPercentage(value) {
            // Check for NaN or Infinity before formatting
            if (isNaN(value) || !isFinite(value)) {
                return "0.00%";
            }
            return value.toFixed(2) + '%';
        }
        
        // --- Export Functions ---
        function printSummary() {
            window.print();
        }
        
        function exportToPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'pt', 'letter');
            let currentY = 40;
            const margin = 40;
            const pageWidth = doc.internal.pageSize.width;

            doc.setFontSize(18);
            doc.text('Commission Report', pageWidth / 2, currentY, { align: 'center' });
            currentY += 30;

            doc.setFontSize(12);
            doc.text(`Calculated On: ${new Date().toLocaleDateString()}`, margin, currentY);
            currentY += 20;

            // Input Details
            const inputDetails = [
                ["Total Sales Amount", formatCurrency(currentCommissionResults.totalSales)],
                ["Tax Deduction Rate", formatPercentage(currentCommissionResults.taxRate)]
            ];
            doc.autoTable({
                startY: currentY,
                head: [['Parameter', 'Value']],
                body: inputDetails,
                theme: 'grid',
                headStyles: { fillColor: [52, 152, 219], textColor: 255 },
                styles: { fontSize: 10, cellPadding: 5 },
                margin: { left: margin, right: margin }
            });
            currentY = doc.autoTable.previous.finalY + 20;

            // Summary Results
            const summaryResults = [
                ["Gross Commission", document.getElementById('grossCommission').textContent],
                ["Tax Deduction", document.getElementById('taxDeduction').textContent],
                ["Net Commission", document.getElementById('netCommission').textContent],
                ["Total Earnings", document.getElementById('totalEarnings').textContent]
            ];
            doc.autoTable({
                startY: currentY,
                head: [['Result', 'Value']],
                body: summaryResults,
                theme: 'grid',
                headStyles: { fillColor: [46, 204, 113], textColor: 255 },
                styles: { fontSize: 10, cellPadding: 5 },
                margin: { left: margin, right: margin }
            });
            currentY = doc.autoTable.previous.finalY + 30;

            // Detailed Commission Breakdown
            doc.addPage();
            currentY = margin;
            doc.setFontSize(16);
            doc.text('Detailed Commission Breakdown', pageWidth / 2, currentY, { align: 'center' });
            currentY += 20;

            const breakdownTableData = detailedCommissionBreakdown.map(item => [
                item.segment,
                formatPercentage(item.rate),
                item.commissionEarned.toFixed(2)
            ]);

            doc.autoTable({
                startY: currentY,
                head: [['Sales Segment', 'Rate Applied', 'Commission Earned']],
                body: breakdownTableData,
                theme: 'grid',
                headStyles: { fillColor: [52, 152, 219], textColor: 255 },
                styles: { fontSize: 8, cellPadding: 4 }, 
                margin: { left: margin, right: margin },
                didDrawPage: function(data) {
                    let pageCount = doc.internal.getNumberOfPages();
                    doc.setFontSize(8);
                    doc.text('Page ' + doc.internal.getCurrentPageInfo().pageNumber + ' of ' + pageCount, data.settings.margin.left, doc.internal.pageSize.height - 20);
                }
            });
            
            doc.save('commission_report.pdf');
        }
        
        function exportToExcel() {
            const wb = XLSX.utils.book_new();
            
            // Sheet 1: Summary
            const summaryData = [
                ["Commission Report", ""],
                ["Calculated On", new Date().toLocaleDateString()],
                [],
                ["Input Details", ""],
                ["Total Sales Amount", currentCommissionResults.totalSales],
                ["Tax Deduction Rate", currentCommissionResults.taxRate], // Unformatted for Excel
                [],
                ["Results", ""],
                ["Gross Commission", currentCommissionResults.grossCommission], // Unformatted
                ["Tax Deduction", currentCommissionResults.taxDeduction], // Unformatted
                ["Net Commission", currentCommissionResults.netCommission], // Unformatted
                ["Total Earnings", currentCommissionResults.totalEarnings] // Unformatted
            ];
            const summaryWs = XLSX.utils.aoa_to_sheet(summaryData);
            XLSX.utils.book_append_sheet(wb, summaryWs, "Summary");

            // Sheet 2: Detailed Commission Breakdown
            const detailedBreakdownHeaders = [
                "Sales Segment", "Rate Applied (%)", "Commission Earned"
            ];
            const detailedBreakdownData = [detailedBreakdownHeaders];
            detailedCommissionBreakdown.forEach(item => {
                detailedBreakdownData.push([
                    item.segment,
                    item.rate, // Raw rate (e.g., 7.5)
                    item.commissionEarned
                ]);
            });
            const detailedBreakdownWs = XLSX.utils.aoa_to_sheet(detailedBreakdownData);
            XLSX.utils.book_append_sheet(wb, detailedBreakdownWs, "Detailed Breakdown");
            
            XLSX.writeFile(wb, 'commission_report.xlsx');
        }
        
        function exportToCSV() {
            let csvContent = "";

            // Summary data
            csvContent += "Commission Report\n";
            csvContent += `"Calculated On","${new Date().toLocaleDateString()}"\n\n`;
            csvContent += `"Input Details",\n`;
            csvContent += `"Total Sales Amount",${currentCommissionResults.totalSales}\n`;
            csvContent += `"Tax Deduction Rate",${currentCommissionResults.taxRate}%\n\n`; // Formatted for CSV
            csvContent += `"Results",\n`;
            csvContent += `"Gross Commission",${currentCommissionResults.grossCommission.toFixed(2)}\n`; // Formatted for CSV
            csvContent += `"Tax Deduction",${currentCommissionResults.taxDeduction.toFixed(2)}\n`; // Formatted for CSV
            csvContent += `"Net Commission",${currentCommissionResults.netCommission.toFixed(2)}\n`; // Formatted for CSV
            csvContent += `"Total Earnings",${currentCommissionResults.totalEarnings.toFixed(2)}\n\n`; // Formatted for CSV

            // Detailed Commission Breakdown
            csvContent += "Detailed Commission Breakdown\n";
            csvContent += "Sales Segment,Rate Applied (%),Commission Earned\n";
            detailedCommissionBreakdown.forEach(item => {
                csvContent += `"${item.segment}",${item.rate.toFixed(2)},${item.commissionEarned.toFixed(2)}\n`;
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', 'commission_report.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function exportToTXT() {
            let txtContent = "";

            txtContent += "Commission Report\n\n";
            txtContent += "Calculated On: " + new Date().toLocaleDateString() + "\n\n";

            txtContent += "--- Input Details ---\n";
            txtContent += `Total Sales Amount: ${formatCurrency(currentCommissionResults.totalSales)}\n`;
            txtContent += `Tax Deduction Rate: ${formatPercentage(currentCommissionResults.taxRate)}\n\n`;

            txtContent += "--- Summary Results ---\n";
            txtContent += `Gross Commission: ${formatCurrency(currentCommissionResults.grossCommission)}\n`;
            txtContent += `Tax Deduction: ${formatCurrency(currentCommissionResults.taxDeduction)}\n`;
            txtContent += `Net Commission: ${formatCurrency(currentCommissionResults.netCommission)}\n`;
            txtContent += `Total Earnings: ${formatCurrency(currentCommissionResults.totalEarnings)}\n\n`;

            txtContent += "--- Detailed Commission Breakdown ---\n";
            txtContent += "Sales Segment        | Rate Applied | Commission Earned\n";
            txtContent += "---------------------|--------------|------------------\n";
            detailedCommissionBreakdown.forEach(item => {
                const segmentFormatted = String(item.segment).padEnd(20);
                const rateFormatted = formatPercentage(item.rate).padEnd(12);
                const commissionFormatted = formatCurrency(item.commissionEarned);
                txtContent += `${segmentFormatted} | ${rateFormatted} | ${commissionFormatted}\n`;
            });

            const blob = new Blob([txtContent], { type: 'text/plain;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', 'commission_report.txt');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // --- Share Link Logic ---
        function generateShareLink() {
            const tiersData = [];
            document.querySelectorAll('#commissionTierTableBody tr').forEach(row => {
                const threshold = row.querySelector('.tier-threshold').value;
                const rate = row.querySelector('.tier-rate').value;
                tiersData.push({t: threshold, r: rate}); // Use short keys for smaller URL
            });

            const dataToShare = {
                ts: document.getElementById('totalSales').value, // Total Sales
                tx: document.getElementById('taxRate').value,    // Tax Rate
                ti: tiersData                                   // Tiers
            };
            const jsonString = JSON.stringify(dataToShare);
            const encodedData = btoa(encodeURIComponent(jsonString)); // Base64 encode after URI encoding
            const shareUrl = `${window.location.origin}${window.location.pathname}?data=${encodedData}`;
            return shareUrl;
        }

        function copyShareLink() {
            const shareUrl = generateShareLink();
            navigator.clipboard.writeText(shareUrl).then(() => {
                alert('Share link copied to clipboard!');
            }).catch(err => {
                console.error('Failed to copy share link: ', err);
                alert('Failed to copy link. Please copy manually: ' + shareUrl);
            });
        }

        function decodeShareLink() {
            const urlParams = new URLSearchParams(window.location.search);
            const encodedData = urlParams.get('data');
            if (encodedData) {
                try {
                    const decodedJsonString = decodeURIComponent(atob(encodedData)); // Decode URI then Base64
                    const sharedData = JSON.parse(decodedJsonString);
                    
                    document.getElementById('totalSales').value = sharedData.ts || 0;
                    document.getElementById('taxRate').value = sharedData.tx || 0;
                    
                    // Clear existing tiers
                    document.getElementById('commissionTierTableBody').innerHTML = '';
                    
                    // Populate tiers from shared data
                    if (sharedData.ti && Array.isArray(sharedData.ti)) {
                        sharedData.ti.forEach(tier => {
                            addTierRowWithData(tier.t, tier.r);
                        });
                    }

                    // Remove budget parameter from URL to prevent re-decoding on refresh
                    const newUrl = new URL(window.location.href);
                    newUrl.searchParams.delete('data');
                    window.history.replaceState({}, document.title, newUrl.toString());

                    calculateCommissions(); // Recalculate based on shared link's data
                } catch (e) {
                    console.error("Failed to decode share link parameters:", e);
                    showError('totalSales-error', 'Invalid share link detected. Please check the URL or try new calculation.');
                }
            }
        }

        function addTierRowWithData(threshold, rate) {
            const tableBody = document.getElementById('commissionTierTableBody');
            const newRow = tableBody.insertRow();
            newRow.innerHTML = `
                <td><input type="number" class="tier-threshold" min="0" step="100" value="${threshold}" aria-label="Sales Threshold"></td>
                <td><input type="number" class="tier-rate" min="0" max="100" step="0.01" value="${rate}" aria-label="Commission Rate"></td>
                <td><button class="remove-tier-btn" aria-label="Remove Tier">X</button></td>
            `;
            // Event listener is handled by delegation on table body
        }


        function setupSocialSharing() {
            const totalSales = currentCommissionResults.totalSales || 0;
            const grossCommission = currentCommissionResults.grossCommission || 0;
            const netCommission = currentCommissionResults.netCommission || 0;
            const taxDeduction = currentCommissionResults.taxDeduction || 0;
            const totalEarnings = currentCommissionResults.totalEarnings || 0;
            const taxRate = currentCommissionResults.taxRate || 0;

            const shareUrl = generateShareLink(); 

            let shareText = `I calculated my commission! With sales of ${formatCurrency(totalSales)}, Gross Commission: ${formatCurrency(grossCommission)}, Tax Deduction (${taxRate.toFixed(2)}%): ${formatCurrency(taxDeduction)}, Net Commission: ${formatCurrency(netCommission)}. Total Earnings: ${formatCurrency(totalEarnings)}. Calculate yours here:`;
            
            document.getElementById('emailShare').onclick = () => {
                window.open(`mailto:?subject=Commission Calculation Results&body=${encodeURIComponent(shareText + ' ' + shareUrl)}`);
            };
            document.getElementById('whatsappShare').onclick = () => {
                window.open(`https://wa.me/?text=${encodeURIComponent(shareText + ' ' + shareUrl)}`);
            };
            document.getElementById('linkedinShare').onclick = () => {
                window.open(`https://www.linkedin.com/shareArticle?mini=true&url=${encodeURIComponent(shareUrl)}&title=${encodeURIComponent('Professional Commission Calculation')}&summary=${encodeURIComponent(shareText)}`);
            };
            document.getElementById('twitterShare').onclick = () => {
                window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(shareText)}&url=${encodeURIComponent(shareUrl)}`);
            };
        }
    </script>
</body>
</html>